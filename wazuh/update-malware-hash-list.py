#!/usr/bin/env python3

import csv
import zipfile
import os
import sys

# Configuration
URL = "https://bazaar.abuse.ch/export/csv/full/"
WORKDIR = "/tmp/malware_hash_update"
ZIPFILE = os.path.join(WORKDIR, "malware.zip")
CSVFILE = os.path.join(WORKDIR, "full.csv")
CDBFILE = "/var/ossec/etc/lists/malware_hash"

# Flag: --no-unzip
NO_UNZIP = len(sys.argv) > 1 and sys.argv[1] == "--no-unzip"

# Ensure working directory exists
os.makedirs(WORKDIR, exist_ok=True)

# Download ZIP unless --no-unzip
if not NO_UNZIP:
    import urllib.request
    print("[*] Downloading latest malware.zip...")
    urllib.request.urlretrieve(URL, ZIPFILE)

# Unzip
if not os.path.exists(ZIPFILE):
    print(f"[-] Error: {ZIPFILE} not found.")
    sys.exit(1)

with zipfile.ZipFile(ZIPFILE, 'r') as zip_ref:
    zip_ref.extractall(WORKDIR)

if not os.path.exists(CSVFILE):
    print(f"[-] Error: {CSVFILE} not found after unzip.")
    sys.exit(1)

# Prepare for reading from the header line
with open(CSVFILE, encoding='utf-8', errors='ignore') as f:
    lines = f.readlines()

# Find the header line and slice from there
header_index = None
for idx, line in enumerate(lines):
    if line.startswith('# "first_seen_utc"'):
        header_index = idx
        break

if header_index is None:
    print("[-] Could not find header line in CSV.")
    sys.exit(1)

# Remove leading "# " and rebuild valid CSV lines
clean_lines = [lines[header_index].lstrip("# ").strip()] + [line.strip() for line in lines[header_index + 1:] if line.strip() and not line.startswith("#")]

# Parse with CSV reader
count = 0
with open(CDBFILE, 'w', encoding='utf-8') as outfile:
    reader = csv.DictReader(clean_lines)
    for row in reader:
        sha256 = row.get("sha256_hash", "").strip().strip('"')
        sig = row.get("signature", "").strip().strip('"')
        if len(sha256) == 64 and all(c in '0123456789abcdefABCDEF' for c in sha256):
            outfile.write(f"{sha256}:{sig}\n")
            count += 1

# Set permissions
os.system(f"chmod 640 {CDBFILE}")
os.system(f"chown wazuh:wazuh {CDBFILE}")

print(f"[+] CDB list updated successfully: {CDBFILE} ({count} entries)")
